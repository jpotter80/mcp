## 2025-11-10 MCP Multi-Server Architecture & Restructuring

### Project Goal
Build self-contained MCP resource servers for various documentation sources (Mojo, DuckDB, etc.) that can be:
- **Distributed independently** via GitHub (as standalone repos or submodules)
- **Developed locally** with shared build infrastructure  
- **Updated automatically** from upstream documentation sources
- **Accessible to all users** (with or without pixi)

### Key Design Decisions (Ratified in RESTRUCTURING_PLAN.md)

1. **Self-Contained Servers**: Each `/servers/{mcp-name}/` is fully standalone with its own runtime code
2. **Multi-Format Support**: `.mdx`, `.md`, and pluggable other formats via ProcessorFactory
3. **YAML Configuration**: All paths/params config-driven, no hardcoded paths in Python
4. **Non-Pixi Compatible**: Each server has `requirements.txt` for pip + venv setup
5. **Doc Automation**: `sync_documentation.sh` syncs from upstream, GitHub Actions for CI/CD
6. **Build Separation**: `/shared/` is dev-time only; `/servers/*/runtime/` is distributable

### Git Implementation Strategy

**8 phases with branches** (see `RESTRUCTURING_PLAN.md` for full details):
1. `restructure/01-directory-structure-and-config` ← Start here
2. `restructure/02-multi-format-doc-support`
3. `restructure/03-parameterize-build-scripts`
4. `restructure/04-move-build-infrastructure`
5. `restructure/05-organize-mojo-server`
6. `restructure/06-create-tooling-and-automation`
7. `restructure/07-update-documentation`
8. `restructure/08-final-cleanup-and-validation`

### Current vs. Target

**Current Issues**: 
- Multiple main.db and search.py files (ambiguous)
- Hardcoded for Mojo only
- No clear distribution model
- Build/runtime code mixed
- No config-driven paths

**Target State**:
- ✅ Shared build in `/shared/` (dev-time only)
- ✅ Per-server runtime in `/servers/{mcp}/runtime/` (distributable)
- ✅ Config-driven YAML paths
- ✅ Multi-format doc support
- ✅ Automation for upstream doc updates
- ✅ Works without pixi (pip + venv)

### Naming Conventions (Standardized)

- **Servers**: `servers/{tool}-{doc-type}-mcp/` (e.g., `mojo-manual-mcp`)
- **Server file**: `{tool}_{doc_type}_mcp_server.py` (e.g., `mojo_manual_mcp_server.py`)
- **Database**: `{tool}_{doc_type}_mcp.db`
- **Config**: `servers/{mcp}/config/{processing,server}_config.yaml`
- **Source docs**: `source-documentation/{tool}/{doc-type}/`

### Environment Variables (Runtime)

```
MOJO_DB_PATH=servers/mojo-manual-mcp/runtime/mojo_manual_mcp.db
MAX_SERVER_URL=http://localhost:8000/v1
EMBED_MODEL_NAME=sentence-transformers/all-mpnet-base-v2
AUTO_START_MAX=1
```

### .gitignore Updates (Phase 1)

Exclude:
- `shared/build/` — ephemeral artifacts
- `*.db`, `*.ducklake` — large databases  
- `__pycache__/`, `.pixi/`, `venv/`
- `.env`, IDE files

### Comprehensive Plan Reference

Full implementation details in: `RESTRUCTURING_PLAN.md`
- 40+ page detailed guide
- Phase-by-phase breakdown
- Git workflows
- Code examples
- Configuration templates
- Automation scripts

### Current Implementation Status

**Phase 2 Complete**: `restructure/02-multi-format-doc-support` ✅
- BaseDocumentProcessor abstract class ✅
- MarkdownProcessor for .md files ✅
- MDXProcessor updated to inherit from BaseDocumentProcessor ✅
- ProcessorFactory with registration system ✅
- pipeline.py using factory pattern ✅
- processing_config.yaml with format field ✅
- All verification tests passing ✅
- Committed and merged to main ✅

### Phase 3 Prompt Ready
**PHASE_3_IMPLEMENTATION_PROMPT.md** created with:
- Feature branch: `restructure/03-parameterize-build-scripts`
- Config loader with variable substitution
- Parameterized build scripts (--config, --mcp-name args)
- Updated pixi.toml tasks
- Complete step-by-step instructions
- Verification checklist

### Next Phase

**Phase 3**: Parameterized build scripts
- Branch: `restructure/03-parameterize-build-scripts`
- Implement dynamic configuration for build processes
- Add config_loader.py for ${VAR} substitution
- Update all build scripts with CLI arguments
- Details in PHASE_3_IMPLEMENTATION_PROMPT.md

### Development Workflow Rules

1. **Dependency Management**: Use `pixi add` for new packages; check `pixi.toml` first (root & server-specific)
2. **Git Strategy**: Checkout restructure branches locally, merge to main — no remote pushes until complete
3. **Code Output**: Avoid unnecessary summaries; use tools directly for changes
4. **Key Dependencies**: `python-frontmatter` already in root `pixi.toml`
5. **Superfluous Summaries**: Do NOT create overview/summary documents unless explicitly requested

### Phase 1-2 Verification Complete ✅

**Comprehensive audit completed confirming**:
- ✅ Phase 1 directory structure: Complete and correct
- ✅ Phase 2 multi-format support: ProcessorFactory, BaseDocumentProcessor, all processors working
- ✅ Phase 3 foundation: config_loader.py with ${VAR} substitution ready
- ✅ Configuration files: processing_config.yaml and server_config.yaml properly parameterized
- ✅ server.py: Recovered from git history, fully functional MCP server
- ✅ No corruption detected in any phases
- ✅ Architecture coherent and aligned with dual distribution vision
- ✅ Git tracking correct: ephemeral artifacts ignored, source code and databases tracked

**Key findings**:
- Database files (.db, .ducklake) ARE tracked in git (essential project data, not ephemeral artifacts)
- Two preprocessing locations temporarily exist (root and shared) — both valid during Phase 4 transition
- Four embedding scripts at root need Phase 3 parameterization with --mcp-name and --config args
- File integrity preserved: No accidental deletions before restructuring

**Guidance documents created for next session**:
- `PHASE_3_IMPLEMENTATION_PROMPT.md` — Step-by-step parameterization instructions
- `PHASE_1_2_VERIFICATION.md` — Comprehensive verification matrix and green light to proceed

### Next Immediate Action

Ready to proceed with Phase 3 when requested. Use PHASE_3_EXECUTION_GUIDE.md as step-by-step guide for parameterizing embedding scripts. Foundation verified sound and safe to proceed.

## 2025-11-14 Phase 3 – Parameterized Embedding Pipeline

- Branch `restructure/03-parameterize-build-scripts` reset to `main` and used for all Phase 3 code changes.
- All four embedding/build scripts now parameterized and aligned with the shared/build layout:
	- `embedding/generate_embeddings.py` – adds `--mcp-name` (default `mojo`) and optional `--config`, uses
		`shared/build/processed_docs/{mcp_name}/chunks` → `shared/build/embeddings/{mcp_name}`.
	- `embedding/consolidate_data.py` – adds `--mcp-name` and optional `--config`, reads from
		`shared/build/processed_docs/{mcp_name}/chunks` and `shared/build/embeddings/{mcp_name}`, writes
		`shared/build/{mcp_name}_embeddings.parquet`.
	- `embedding/load_to_ducklake.py` – adds `--mcp-name`, loads from
		`shared/build/{mcp_name}_embeddings.parquet` into DuckLake catalog
		`servers/{mcp_name}-manual-mcp/runtime/{mcp_name}_catalog.ducklake` as `{mcp_name}_docs`.
	- `embedding/create_indexes.py` – adds `--mcp-name`, materializes and indexes
		`{mcp_name}_docs` → `{mcp_name}_docs_indexed` in
		`servers/{mcp_name}-manual-mcp/runtime/{mcp_name}_manual_mcp.db` (HNSW + FTS).
- Root `pixi.toml` updated with Phase 3 tasks:
	- `mojo-process`, `mojo-generate-embeddings`, `mojo-consolidate`, `mojo-load`, `mojo-index`, and `mojo-build` (chained).
	- Demonstration generic tasks `process-mojo` and `generate-embeddings-mojo` using the new CLI args.
- New documentation at `shared/embedding/README.md` explains the embedding pipeline, CLI flags, and shared/build
	conventions for Phase 3.
- All four embedding scripts successfully pass `python -m py_compile ...` on
	`restructure/03-parameterize-build-scripts`.
- Next steps:
	- On `test/restructure`, fast-forward/reset to include Phase 3 changes, then run:
		- `pixi run mojo-process`
		- `pixi run mojo-generate-embeddings`
		- `pixi run mojo-consolidate`
		- `pixi run mojo-load`
		- `pixi run mojo-index`
	- After successful verification, merge `restructure/03-parameterize-build-scripts` back into `main`.

