## 2025-11-10 MCP Multi-Server Architecture & Restructuring

### Project Goal
Build self-contained MCP resource servers for various documentation sources (Mojo, DuckDB, etc.) that can be:
- **Distributed independently** via GitHub (as standalone repos or submodules)
- **Developed locally** with shared build infrastructure  
- **Updated automatically** from upstream documentation sources
- **Accessible to all users** (with or without pixi)

### Key Design Decisions (Ratified in RESTRUCTURING_PLAN.md)

1. **Self-Contained Servers**: Each `/servers/{mcp-name}/` is fully standalone with its own runtime code
2. **Multi-Format Support**: `.mdx`, `.md`, and pluggable other formats via ProcessorFactory
3. **YAML Configuration**: All paths/params config-driven, no hardcoded paths in Python
4. **Non-Pixi Compatible**: Each server has `requirements.txt` for pip + venv setup
5. **Doc Automation**: `sync_documentation.sh` syncs from upstream, GitHub Actions for CI/CD
6. **Build Separation**: `/shared/` is dev-time only; `/servers/*/runtime/` is distributable

### Git Implementation Strategy

**8 phases with branches** (see `RESTRUCTURING_PLAN.md` for full details):
1. `restructure/01-directory-structure-and-config` ← Start here
2. `restructure/02-multi-format-doc-support`
3. `restructure/03-parameterize-build-scripts`
4. `restructure/04-move-build-infrastructure`
5. `restructure/05-organize-mojo-server`
6. `restructure/06-create-tooling-and-automation`
7. `restructure/07-update-documentation`
8. `restructure/08-final-cleanup-and-validation`

### Current vs. Target

**Current Issues**: 
- Multiple main.db and search.py files (ambiguous)
- Hardcoded for Mojo only
- No clear distribution model
- Build/runtime code mixed
- No config-driven paths

**Target State**:
- ✅ Shared build in `/shared/` (dev-time only)
- ✅ Per-server runtime in `/servers/{mcp}/runtime/` (distributable)
- ✅ Config-driven YAML paths
- ✅ Multi-format doc support
- ✅ Automation for upstream doc updates
- ✅ Works without pixi (pip + venv)

### Naming Conventions (Standardized)

- **Servers**: `servers/{tool}-{doc-type}-mcp/` (e.g., `mojo-manual-mcp`)
- **Server file**: `{tool}_{doc_type}_mcp_server.py` (e.g., `mojo_manual_mcp_server.py`)
- **Database**: `{tool}_{doc_type}_mcp.db`
- **Config**: `servers/{mcp}/config/{processing,server}_config.yaml`
- **Source docs**: `source-documentation/{tool}/{doc-type}/`

### Environment Variables (Runtime)

```
MOJO_DB_PATH=servers/mojo-manual-mcp/runtime/mojo_manual_mcp.db
MAX_SERVER_URL=http://localhost:8000/v1
EMBED_MODEL_NAME=sentence-transformers/all-mpnet-base-v2
AUTO_START_MAX=1
```

### .gitignore Updates (Phase 1)

Exclude:
- `shared/build/` — ephemeral artifacts
- `*.db`, `*.ducklake` — large databases  
- `__pycache__/`, `.pixi/`, `venv/`
- `.env`, IDE files

### Comprehensive Plan Reference

Full implementation details in: `RESTRUCTURING_PLAN.md`
- 40+ page detailed guide
- Phase-by-phase breakdown
- Git workflows
- Code examples
- Configuration templates
- Automation scripts

### Current Implementation Status

**Phase 6 Complete**: `feature/phase-6-server-structure` ✅
- Mojo server runtime organized in `/servers/mojo-manual-mcp/runtime/` ✅
- `search.py` and `mojo_manual_mcp_server.py` moved and updated ✅
- Root-level artifacts cleaned up ✅
- Server configuration updated and verified ✅
- Search functionality verified with MAX server ✅
- Linting errors fixed ✅

### Phase 7 Prompt Ready
**PHASE_7_IMPLEMENTATION_PROMPT.md** (to be created/executed next):
- Create tooling and automation scripts
- `sync_documentation.sh`
- `scaffold_new_mcp.sh`
- `build_mcp.sh`
- Complete step-by-step instructions
- Verification checklist

### Next Phase

**Phase 3**: Parameterized build scripts
- Branch: `restructure/03-parameterize-build-scripts`
- Implement dynamic configuration for build processes
- Add config_loader.py for ${VAR} substitution
- Update all build scripts with CLI arguments
- Details in PHASE_3_IMPLEMENTATION_PROMPT.md

### Development Workflow Rules

1. **CRITICAL - Code Changes on Feature Branch Only**:
   - **ALWAYS make code changes on feature branches** (e.g., `restructure/05-move-build-infrastructure`)
   - **NEVER make code changes on `test/restructure` branch**
   - Test branch is ONLY for running/testing code, not editing it
   - If you accidentally make changes on test branch, commit them and cherry-pick to feature branch
   - Workflow: Edit on feature branch → Commit → Switch to `test/restructure` → Merge/Test → Switch back to feature branch for more edits

2. **CRITICAL - Testing Branch Workflow**: 
   - **NEVER test on feature branches directly**
   - **ALWAYS switch to `test/restructure` branch for testing/running commands**
   - The testing branch has all dependencies pre-installed via `pixi install`
   - This avoids reinstalling dependencies for every feature branch
   - Workflow: Make changes on feature branch → Switch to `test/restructure` → Test → Switch back to feature branch if more changes needed

3. **CRITICAL - Terminal Output**: 
   - **DO NOT assume terminal output**
   - **ALWAYS ask user to provide terminal output if not visible**
   - The AI may not have access to terminal output in all cases
   - Wait for user to paste output before proceeding

4. **CRITICAL - MAX Server for Development**:
   - In MCP production, the host automatically starts MAX server via AUTO_START_MAX=1
   - In test/development, MAX server must be started manually: `pixi run max-serve` or `max serve --model sentence-transformers/all-mpnet-base-v2`
   - Embedding scripts now check if MAX server is running and provide clear error messages
   - Always verify MAX server is running before embedding generation

5. **Dependency Management**: Use `pixi add` for new packages; check `pixi.toml` first (root & server-specific)
6. **Git Strategy**: Checkout restructure branches locally, merge to main — no remote pushes until complete
7. **Code Output**: Avoid unnecessary summaries; use tools directly for changes
8. **Key Dependencies**: `python-frontmatter` already in root `pixi.toml`
9. **Superfluous Summaries**: Do NOT create overview/summary documents unless explicitly requested

### Phase 1-2 Verification Complete ✅

**Comprehensive audit completed confirming**:
- ✅ Phase 1 directory structure: Complete and correct
- ✅ Phase 2 multi-format support: ProcessorFactory, BaseDocumentProcessor, all processors working
- ✅ Phase 3 foundation: config_loader.py with ${VAR} substitution ready
- ✅ Configuration files: processing_config.yaml and server_config.yaml properly parameterized
- ✅ server.py: Recovered from git history, fully functional MCP server
- ✅ No corruption detected in any phases
- ✅ Architecture coherent and aligned with dual distribution vision
- ✅ Git tracking correct: ephemeral artifacts ignored, source code and databases tracked

**Key findings**:
- Database files (.db, .ducklake) ARE tracked in git (essential project data, not ephemeral artifacts)
- Two preprocessing locations temporarily exist (root and shared) — both valid during Phase 4 transition
- Four embedding scripts at root need Phase 3 parameterization with --mcp-name and --config args
- File integrity preserved: No accidental deletions before restructuring

**Guidance documents created for next session**:
- `PHASE_3_IMPLEMENTATION_PROMPT.md` — Step-by-step parameterization instructions
- `PHASE_1_2_VERIFICATION.md` — Comprehensive verification matrix and green light to proceed

### Next Immediate Action

Ready to proceed with Phase 3 when requested. Use PHASE_3_EXECUTION_GUIDE.md as step-by-step guide for parameterizing embedding scripts. Foundation verified sound and safe to proceed.

## 2025-11-14 Phase 3 – Parameterized Embedding Pipeline

- Branch `restructure/03-parameterize-build-scripts` reset to `main` and used for all Phase 3 code changes.
- All four embedding/build scripts now parameterized and aligned with the shared/build layout:
	- `embedding/generate_embeddings.py` – adds `--mcp-name` (default `mojo`) and optional `--config`, uses
		`shared/build/processed_docs/{mcp_name}/chunks` → `shared/build/embeddings/{mcp_name}`.
	- `embedding/consolidate_data.py` – adds `--mcp-name` and optional `--config`, reads from
		`shared/build/processed_docs/{mcp_name}/chunks` and `shared/build/embeddings/{mcp_name}`, writes
		`shared/build/{mcp_name}_embeddings.parquet`.
	- `embedding/load_to_ducklake.py` – adds `--mcp-name`, loads from
		`shared/build/{mcp_name}_embeddings.parquet` into DuckLake catalog
		`servers/{mcp_name}-manual-mcp/runtime/{mcp_name}_catalog.ducklake` as `{mcp_name}_docs`.
	- `embedding/create_indexes.py` – adds `--mcp-name`, materializes and indexes
		`{mcp_name}_docs` → `{mcp_name}_docs_indexed` in
		`servers/{mcp_name}-manual-mcp/runtime/{mcp_name}_manual_mcp.db` (HNSW + FTS).
- Root `pixi.toml` updated with Phase 3 tasks:
	- `mojo-process`, `mojo-generate-embeddings`, `mojo-consolidate`, `mojo-load`, `mojo-index`, and `mojo-build` (chained).
	- Demonstration generic tasks `process-mojo` and `generate-embeddings-mojo` using the new CLI args.
- New documentation at `shared/embedding/README.md` explains the embedding pipeline, CLI flags, and shared/build
	conventions for Phase 3.
- All four embedding scripts successfully pass `python -m py_compile ...` on
	`restructure/03-parameterize-build-scripts`.

## 2025-11-14 Phase 4 – Config Loader Integration ✅ COMPLETE

- Branch `restructure/04-config-loader-integration` created and completed
- **Problem identified**: Original attempt failed because `shared/preprocessing/src/__init__.py` imports triggered missing `frontmatter` dependency
- **Solution**: Moved `config_loader.py` from `shared/preprocessing/src/` to `shared/` (root of shared directory) to avoid package `__init__.py` import issues
- **Changes made**:
	- Updated `preprocessing/src/pipeline.py` to import from `shared.config_loader` instead of `shared.preprocessing.src.config_loader`
	- Updated `init_directories()` to accept `config_path` parameter and use `load_config_with_substitution()`
	- Updated `DocumentProcessingPipeline.__init__()` to use `load_config_with_substitution()` and pass `config_path` to `init_directories()`
	- Updated `servers/mojo-manual-mcp/config/processing_config.yaml` to use `${PROJECT_ROOT}` for source directory (was literal path)
- **Verification on `test/restructure`**:
	- ✅ Config loader correctly substitutes variables: Source = `/home/james/mcp/source-documentation/mojo/manual`, Output = `/home/james/mcp/shared/build/processed_docs/mojo`
	- ✅ `pixi run mojo-process` successfully processes 45 docs, generates 1155 chunks, validates successfully
	- ✅ No `${PROJECT_ROOT}` literals appear in output or created directories
	- ✅ All paths resolve correctly to absolute paths
- **Phase 4 objectives achieved**:
	- Preprocessing pipeline now uses config_loader with variable substitution
	- All `${PROJECT_ROOT}` and `${SERVER_ROOT}` variables properly resolved
	- Existing behavior preserved (45 docs, chunking, validation all working)
	- No regressions detected
- **Ready for Phase 5**: Move build infrastructure and organize server structure

## 2025-11-17 Phase 5 – Move Build Infrastructure to Shared ✅ COMPLETE

- Branch `restructure/05-move-build-infrastructure` created and completed successfully
- **All build infrastructure moved to `/shared/` directory**:
	- Moved `/preprocessing/` → `/shared/preprocessing/` (complete migration)
	- Moved `/embedding/` → `/shared/embedding/` (all scripts)
	- Removed old `/preprocessing/` and `/embedding/` directories
	- Created `shared/embedding/__init__.py` module file
- **Updated all import paths**:
	- Fixed `shared/preprocessing/src/pipeline.py` to use relative import for `processor_factory`
	- Added sys.path manipulation in embedding scripts for shared module access
	- Removed duplicate `config_loader.py` from `shared/preprocessing/src/`
	- All imports now correctly reference `shared.config_loader` and relative imports within packages
- **Updated `pixi.toml` task definitions**:
	- `mojo-process`: `python -m shared.preprocessing.src.pipeline`
	- `mojo-generate-embeddings`: `python shared/embedding/generate_embeddings.py`
	- `mojo-consolidate`: `python shared/embedding/consolidate_data.py`
	- `mojo-load`: `python shared/embedding/load_to_ducklake.py`
	- `mojo-index`: `python shared/embedding/create_indexes.py`
- **Added MAX server health check**:
	- New `check_max_server()` function in `generate_embeddings.py`
	- Verifies MAX server accessibility before attempting embeddings
	- Provides clear error message with start instructions if server not running
	- Addresses gap where MCP auto-starts server but test environment doesn't
- **Verification on `test/restructure` - All tests passing**:
	- ✅ `pixi run mojo-process`: 45 docs, 1155 chunks (as expected)
	- ✅ `pixi run mojo-generate-embeddings`: All 45 files processed (with MAX server check)
	- ✅ `pixi run mojo-consolidate`: 1125 records consolidated to parquet
	- ✅ `pixi run mojo-load`: Data loaded to DuckLake catalog
	- ✅ `pixi run mojo-index`: HNSW + FTS indexes created successfully
	- ✅ `pixi run search`: Hybrid search returns quality results (tested "Explain ownership in Mojo?")
- **Phase 5 objectives achieved**:
	- All build-time infrastructure consolidated in `/shared/` directory
	- All imports and paths updated correctly
	- Full pipeline verified working end-to-end
	- Search quality confirmed with hybrid search test
	- No regressions detected
	- Added critical developer experience improvements (MAX server check)
- **Updated workflow documentation in `.memory.md`**:
	- Added critical rule: Code changes ONLY on feature branches
	- Emphasized testing ONLY on `test/restructure` branch
	- Documented MAX server manual start requirement for development
	- Clarified MCP production vs development environment differences
- **Ready for Phase 6**: Organize Mojo server structure and move runtime files

