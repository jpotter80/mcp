{"chunk_id": "operations_manual-non-deterministic_behavior-000", "document_id": "operations_manual-non-deterministic_behavior", "content": "Several operators in DuckDB exhibit non-deterministic behavior.\nMost notably, SQL uses set semantics, which allows results to be returned in a different order.\nDuckDB exploits this to improve performance, particularly when performing multi-threaded query execution.\nOther factors, such as using different compilers, operating systems, and hardware architectures, can also cause changes in ordering.\nThis page documents the cases where non-determinism is an _expected behavior_.\nIf you would like to make your queries deterministic, see the [“Working Around Non-Determinism” section](#working-around-non-determinism).\n\n## Set Semantics\n\nOne of the most common sources of non-determinism is the set semantics used by SQL.\nE.g., if you run the following query repeatedly, you may get two different results:\n\n```sql\nSELECT *\nFROM (\n SELECT 'A' AS x\n UNION\n SELECT 'B' AS x\n);\n```\n\nBoth results `A`, `B` and `B`, `A` are correct.", "position": 0, "token_count": 224, "has_code": true, "section_hierarchy": ["Set Semantics"], "metadata": {"chunk_id": "operations_manual-non-deterministic_behavior-000", "document_id": "operations_manual-non-deterministic_behavior", "position": 0, "token_count": 224, "has_code": true, "overlap_with_previous": false, "section_hierarchy": ["Set Semantics"], "file_path": "operations_manual/non-deterministic_behavior.md", "url": "/operations_manual/non-deterministic_behavior", "title": "Non-Deterministic Behavior", "category": null, "tags": [], "section_url": "/operations_manual/non-deterministic_behavior#set-semantics"}}
{"chunk_id": "operations_manual-non-deterministic_behavior-001", "document_id": "operations_manual-non-deterministic_behavior", "content": "## Different Results on Different Platforms: `array_distinct`\n\nThe `array_distinct` function may return results [in a different order on different platforms](https://github.com/duckdb/duckdb/issues/13746):\n\n```sql\nSELECT array_distinct(['A', 'A', 'B', NULL, NULL]) AS arr;\n```\n\nFor this query, both `[A, B]` and `[B, A]` are valid results.", "position": 1, "token_count": 115, "has_code": true, "section_hierarchy": ["Different Results on Different Platforms: `array_distinct`"], "metadata": {"chunk_id": "operations_manual-non-deterministic_behavior-001", "document_id": "operations_manual-non-deterministic_behavior", "position": 1, "token_count": 115, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Different Results on Different Platforms: `array_distinct`"], "file_path": "operations_manual/non-deterministic_behavior.md", "url": "/operations_manual/non-deterministic_behavior", "title": "Non-Deterministic Behavior", "category": null, "tags": [], "section_url": "/operations_manual/non-deterministic_behavior#different-results-on-different-platforms-arraydistinct"}}
{"chunk_id": "operations_manual-non-deterministic_behavior-002", "document_id": "operations_manual-non-deterministic_behavior", "content": "## Floating-Point Aggregate Operations with Multi-Threading\n\nFloating-point inaccuracies may produce different results when run in a multi-threaded configurations:\nFor example, [`stddev` and `corr` may produce non-deterministic results](https://github.com/duckdb/duckdb/issues/13763):\n\n```sql\nCREATE TABLE tbl AS\n SELECT 'ABCDEFG'[floor(random() * 7 + 1)::INT] AS s, 3.7 AS x, i AS y\n FROM range(1, 1_000_000) r(i);\n\nSELECT s, stddev(x) AS standard_deviation, corr(x, y) AS correlation\nFROM tbl\nGROUP BY s\nORDER BY s;\n```\n\nThe expected standard deviations and correlations from this query are 0 for all values of `s`.\nHowever, when executed on multiple threads, the query may return small numbers (`0 <= z < 10e-16`) due to floating-point inaccuracies.", "position": 2, "token_count": 234, "has_code": true, "section_hierarchy": ["Floating-Point Aggregate Operations with Multi-Threading"], "metadata": {"chunk_id": "operations_manual-non-deterministic_behavior-002", "document_id": "operations_manual-non-deterministic_behavior", "position": 2, "token_count": 234, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Floating-Point Aggregate Operations with Multi-Threading"], "file_path": "operations_manual/non-deterministic_behavior.md", "url": "/operations_manual/non-deterministic_behavior", "title": "Non-Deterministic Behavior", "category": null, "tags": [], "section_url": "/operations_manual/non-deterministic_behavior#floating-point-aggregate-operations-with-multi-threading"}}
{"chunk_id": "operations_manual-non-deterministic_behavior-003", "document_id": "operations_manual-non-deterministic_behavior", "content": "## Working Around Non-Determinism\n\nFor the majority of use cases, non-determinism is not causing any issues.\nHowever, there are some cases where deterministic results are desirable.\nIn these cases, try the following workarounds:\n\n1. Limit the number of threads to prevent non-determinism introduced by multi-threading.\n\n ```sql\n SET threads = 1;\n ```\n\n2. Enforce ordering. For example, you can use the [`ORDER BY ALL` clause]({% link docs/stable/sql/query_syntax/orderby.md %}#order-by-all):\n\n ```sql\n SELECT *\n FROM (\n SELECT 'A' AS x\n UNION\n SELECT 'B' AS x\n )\n ORDER BY ALL;\n ```\n\n You can also sort lists using [`list_sort`]({% link docs/stable/sql/functions/list.md %}#list_sortlist):\n\n ```sql\n SELECT list_sort(array_distinct(['A', 'A', 'B', NULL, NULL])) AS i\n ORDER BY i;", "position": 3, "token_count": 241, "has_code": true, "section_hierarchy": ["Working Around Non-Determinism"], "metadata": {"chunk_id": "operations_manual-non-deterministic_behavior-003", "document_id": "operations_manual-non-deterministic_behavior", "position": 3, "token_count": 241, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Working Around Non-Determinism"], "file_path": "operations_manual/non-deterministic_behavior.md", "url": "/operations_manual/non-deterministic_behavior", "title": "Non-Deterministic Behavior", "category": null, "tags": [], "section_url": "/operations_manual/non-deterministic_behavior#working-around-non-determinism"}}
{"chunk_id": "operations_manual-non-deterministic_behavior-004", "document_id": "operations_manual-non-deterministic_behavior", "content": "```\n\n It's also possible to introduce a [deterministic shuffling]({% post_url 2024-08-19-duckdb-tricks-part-1 %}#shuffling-data).", "position": 4, "token_count": 49, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "operations_manual-non-deterministic_behavior-004", "document_id": "operations_manual-non-deterministic_behavior", "position": 4, "token_count": 49, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "operations_manual/non-deterministic_behavior.md", "url": "/operations_manual/non-deterministic_behavior", "title": "Non-Deterministic Behavior", "category": null, "tags": [], "section_url": "/operations_manual/non-deterministic_behavior"}}
