{"chunk_id": "guides-python-multiple_threads-000", "document_id": "guides-python-multiple_threads", "content": "This page demonstrates how to simultaneously insert into and read from a DuckDB database across multiple Python threads.\nThis could be useful in scenarios where new data is flowing in and an analysis should be periodically re-run.\nNote that this is all within a single Python process (see the [FAQ]({% link faq.md %}) for details on DuckDB concurrency).\nFeel free to follow along in this [Google Colab notebook](https://colab.research.google.com/drive/190NB2m-LIfDcMamCY5lIzaD2OTMnYclB?usp=sharing).", "position": 0, "token_count": 137, "has_code": false, "section_hierarchy": [], "metadata": {"chunk_id": "guides-python-multiple_threads-000", "document_id": "guides-python-multiple_threads", "position": 0, "token_count": 137, "has_code": false, "overlap_with_previous": false, "section_hierarchy": [], "file_path": "guides/python/multiple_threads.md", "url": "/guides/python/multiple_threads", "title": "Multiple Python Threads", "category": null, "tags": [], "section_url": "/guides/python/multiple_threads"}}
{"chunk_id": "guides-python-multiple_threads-001", "document_id": "guides-python-multiple_threads", "content": "## Setup\n\nFirst, import DuckDB and several modules from the Python standard library.\nNote: if using Pandas, add `import pandas` at the top of the script as well (as it must be imported prior to the multi-threading).\nThen connect to a file-backed DuckDB database and create an example table to store inserted data.\nThis table will track the name of the thread that completed the insert and automatically insert the timestamp when that insert occurred using the [`DEFAULT` expression]({% link docs/stable/sql/statements/create_table.md %}#syntax).\n\n```python\nimport duckdb\nfrom threading import Thread, current_thread\nimport random\n\nduckdb_con = duckdb.connect('my_peristent_db.duckdb')", "position": 1, "token_count": 172, "has_code": true, "section_hierarchy": ["Setup"], "metadata": {"chunk_id": "guides-python-multiple_threads-001", "document_id": "guides-python-multiple_threads", "position": 1, "token_count": 172, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Setup"], "file_path": "guides/python/multiple_threads.md", "url": "/guides/python/multiple_threads", "title": "Multiple Python Threads", "category": null, "tags": [], "section_url": "/guides/python/multiple_threads#setup"}}
{"chunk_id": "guides-python-multiple_threads-002", "document_id": "guides-python-multiple_threads", "content": "# Use connect without parameters for an in-memory database", "position": 2, "token_count": 13, "has_code": false, "section_hierarchy": ["Use connect without parameters for an in-memory database"], "metadata": {"chunk_id": "guides-python-multiple_threads-002", "document_id": "guides-python-multiple_threads", "position": 2, "token_count": 13, "has_code": false, "overlap_with_previous": true, "section_hierarchy": ["Use connect without parameters for an in-memory database"], "file_path": "guides/python/multiple_threads.md", "url": "/guides/python/multiple_threads", "title": "Multiple Python Threads", "category": null, "tags": [], "section_url": "/guides/python/multiple_threads#use-connect-without-parameters-for-an-in-memory-database"}}
{"chunk_id": "guides-python-multiple_threads-003", "document_id": "guides-python-multiple_threads", "content": "# duckdb_con = duckdb.connect()\nduckdb_con.execute(\"\"\"\n CREATE OR REPLACE TABLE my_inserts (\n thread_name VARCHAR,\n insert_time TIMESTAMP DEFAULT current_timestamp\n )\n\"\"\")\n```", "position": 3, "token_count": 60, "has_code": true, "section_hierarchy": ["duckdb_con = duckdb.connect()"], "metadata": {"chunk_id": "guides-python-multiple_threads-003", "document_id": "guides-python-multiple_threads", "position": 3, "token_count": 60, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["duckdb_con = duckdb.connect()"], "file_path": "guides/python/multiple_threads.md", "url": "/guides/python/multiple_threads", "title": "Multiple Python Threads", "category": null, "tags": [], "section_url": "/guides/python/multiple_threads#duckdbcon--duckdbconnect"}}
{"chunk_id": "guides-python-multiple_threads-004", "document_id": "guides-python-multiple_threads", "content": "## Reader and Writer Functions\n\nNext, define functions to be executed by the writer and reader threads.\nEach thread must use the `.cursor()` method to create a thread-local connection to the same DuckDB file based on the original connection.\nThis approach also works with in-memory DuckDB databases.\n\n```python\ndef write_from_thread(duckdb_con):\n # Create a DuckDB connection specifically for this thread\n local_con = duckdb_con.cursor()\n # Insert a row with the name of the thread. insert_time is auto-generated.\n thread_name = str(current_thread().name)\n result = local_con.execute(\"\"\"\n INSERT INTO my_inserts (thread_name)\n VALUES (?)\n \"\"\", (thread_name,)).fetchall()", "position": 4, "token_count": 184, "has_code": true, "section_hierarchy": ["Reader and Writer Functions"], "metadata": {"chunk_id": "guides-python-multiple_threads-004", "document_id": "guides-python-multiple_threads", "position": 4, "token_count": 184, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Reader and Writer Functions"], "file_path": "guides/python/multiple_threads.md", "url": "/guides/python/multiple_threads", "title": "Multiple Python Threads", "category": null, "tags": [], "section_url": "/guides/python/multiple_threads#reader-and-writer-functions"}}
{"chunk_id": "guides-python-multiple_threads-005", "document_id": "guides-python-multiple_threads", "content": "def read_from_thread(duckdb_con):\n # Create a DuckDB connection specifically for this thread\n local_con = duckdb_con.cursor()\n # Query the current row count\n thread_name = str(current_thread().name)\n results = local_con.execute(\"\"\"\n SELECT\n ? AS thread_name,\n count(*) AS row_counter,\n current_timestamp\n FROM my_inserts\n \"\"\", (thread_name,)).fetchall()\n print(results)", "position": 5, "token_count": 117, "has_code": false, "section_hierarchy": [], "metadata": {"chunk_id": "guides-python-multiple_threads-005", "document_id": "guides-python-multiple_threads", "position": 5, "token_count": 117, "has_code": false, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/python/multiple_threads.md", "url": "/guides/python/multiple_threads", "title": "Multiple Python Threads", "category": null, "tags": [], "section_url": "/guides/python/multiple_threads"}}
{"chunk_id": "guides-python-multiple_threads-006", "document_id": "guides-python-multiple_threads", "content": "```", "position": 6, "token_count": 5, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "guides-python-multiple_threads-006", "document_id": "guides-python-multiple_threads", "position": 6, "token_count": 5, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/python/multiple_threads.md", "url": "/guides/python/multiple_threads", "title": "Multiple Python Threads", "category": null, "tags": [], "section_url": "/guides/python/multiple_threads"}}
{"chunk_id": "guides-python-multiple_threads-007", "document_id": "guides-python-multiple_threads", "content": "## Create Threads\n\nWe define how many writers and readers to use, and define a list to track all of the threads that will be created.\nThen, create first writer and then reader threads.\nNext, shuffle them so that they will be kicked off in a random order to simulate simultaneous writers and readers.\nNote that the threads have not yet been executed, only defined.\n\n```python\nwrite_thread_count = 50\nread_thread_count = 5\nthreads = []", "position": 7, "token_count": 98, "has_code": true, "section_hierarchy": ["Create Threads"], "metadata": {"chunk_id": "guides-python-multiple_threads-007", "document_id": "guides-python-multiple_threads", "position": 7, "token_count": 98, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Create Threads"], "file_path": "guides/python/multiple_threads.md", "url": "/guides/python/multiple_threads", "title": "Multiple Python Threads", "category": null, "tags": [], "section_url": "/guides/python/multiple_threads#create-threads"}}
{"chunk_id": "guides-python-multiple_threads-008", "document_id": "guides-python-multiple_threads", "content": "# Create multiple writer and reader threads (in the same process)\n# Pass in the same connection as an argument\nfor i in range(write_thread_count):\n threads.append(Thread(target = write_from_thread,\n args = (duckdb_con,),\n name = 'write_thread_' + str(i)))\n\nfor j in range(read_thread_count):\n threads.append(Thread(target = read_from_thread,\n args = (duckdb_con,),\n name = 'read_thread_' + str(j)))\n\n# Shuffle the threads to simulate a mix of readers and writers\nrandom.seed(6) # Set the seed to ensure consistent results when testing\nrandom.shuffle(threads)\n```\n\n## Run Threads and Show Results\n\nNow, kick off all threads to run in parallel, then wait for all of them to finish before printing out the results.\nNote that the timestamps of readers and writers are interspersed as expected due to the randomization.\n\n```python\n# Kick off all threads in parallel\nfor thread in threads:\n thread.start()", "position": 8, "token_count": 242, "has_code": true, "section_hierarchy": ["Kick off all threads in parallel"], "metadata": {"chunk_id": "guides-python-multiple_threads-008", "document_id": "guides-python-multiple_threads", "position": 8, "token_count": 242, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Kick off all threads in parallel"], "file_path": "guides/python/multiple_threads.md", "url": "/guides/python/multiple_threads", "title": "Multiple Python Threads", "category": null, "tags": [], "section_url": "/guides/python/multiple_threads#kick-off-all-threads-in-parallel"}}
{"chunk_id": "guides-python-multiple_threads-009", "document_id": "guides-python-multiple_threads", "content": "# Kick off all threads in parallel\nfor thread in threads:\n thread.start()\n\n# Ensure all threads complete before printing final results\nfor thread in threads:\n thread.join()\n\nprint(duckdb_con.execute(\"\"\"\n SELECT *\n FROM my_inserts\n ORDER BY\n insert_time\n\"\"\").df())\n```", "position": 9, "token_count": 75, "has_code": true, "section_hierarchy": ["Ensure all threads complete before printing final results"], "metadata": {"chunk_id": "guides-python-multiple_threads-009", "document_id": "guides-python-multiple_threads", "position": 9, "token_count": 75, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Ensure all threads complete before printing final results"], "file_path": "guides/python/multiple_threads.md", "url": "/guides/python/multiple_threads", "title": "Multiple Python Threads", "category": null, "tags": [], "section_url": "/guides/python/multiple_threads#ensure-all-threads-complete-before-printing-final-results"}}
