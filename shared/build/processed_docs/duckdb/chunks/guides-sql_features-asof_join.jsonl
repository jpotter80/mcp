{"chunk_id": "guides-sql_features-asof_join-000", "document_id": "guides-sql_features-asof_join", "content": "## What is an AsOf Join?\n\nTime series data is not always perfectly aligned.\nClocks may be slightly off, or there may be a delay between cause and effect.\nThis can make connecting two sets of ordered data challenging.\nAsOf joins are a tool for solving this and other similar problems.\n\nOne of the problems that AsOf joins are used to solve is\nfinding the value of a varying property at a specific point in time.\nThis use case is so common that it is where the name came from:\n\n_Give me the value of the property **as of this time**_.\n\nMore generally, however, AsOf joins embody some common temporal analytic semantics,\nwhich can be cumbersome and slow to implement in standard SQL.", "position": 0, "token_count": 152, "has_code": false, "section_hierarchy": ["What is an AsOf Join?"], "metadata": {"chunk_id": "guides-sql_features-asof_join-000", "document_id": "guides-sql_features-asof_join", "position": 0, "token_count": 152, "has_code": false, "overlap_with_previous": false, "section_hierarchy": ["What is an AsOf Join?"], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join#what-is-an-asof-join"}}
{"chunk_id": "guides-sql_features-asof_join-001", "document_id": "guides-sql_features-asof_join", "content": "## Portfolio Example Dataset\n\nLet's start with a concrete example.\nSuppose we have a table of stock [`prices`]({% link data/prices.csv %}) with timestamps:\n\n| ticker | when | price |\n| :----- | :--- | ----: |\n| APPL | 2001-01-01 00:00:00 | 1 |\n| APPL | 2001-01-01 00:01:00 | 2 |\n| APPL | 2001-01-01 00:02:00 | 3 |\n| MSFT | 2001-01-01 00:00:00 | 1 |\n| MSFT | 2001-01-01 00:01:00 | 2 |\n| MSFT | 2001-01-01 00:02:00 | 3 |\n| GOOG | 2001-01-01 00:00:00 | 1 |\n| GOOG | 2001-01-01 00:01:00 | 2 |\n| GOOG | 2001-01-01 00:02:00 | 3 |", "position": 1, "token_count": 227, "has_code": false, "section_hierarchy": ["Portfolio Example Dataset"], "metadata": {"chunk_id": "guides-sql_features-asof_join-001", "document_id": "guides-sql_features-asof_join", "position": 1, "token_count": 227, "has_code": false, "overlap_with_previous": true, "section_hierarchy": ["Portfolio Example Dataset"], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join#portfolio-example-dataset"}}
{"chunk_id": "guides-sql_features-asof_join-002", "document_id": "guides-sql_features-asof_join", "content": "We have another table containing portfolio [`holdings`]({% link data/holdings.csv %}) at various points in time:\n\n| ticker | when | shares |\n| :----- | :--- | -----: |\n| APPL | 2000-12-31 23:59:30 | 5.16 |\n| APPL | 2001-01-01 00:00:30 | 2.94 |\n| APPL | 2001-01-01 00:01:30 | 24.13 |\n| GOOG | 2000-12-31 23:59:30 | 9.33 |\n| GOOG | 2001-01-01 00:00:30 | 23.45 |\n| GOOG | 2001-01-01 00:01:30 | 10.58 |\n| DATA | 2000-12-31 23:59:30 | 6.65 |\n| DATA | 2001-01-01 00:00:30 | 17.95 |\n| DATA | 2001-01-01 00:01:30 | 18.37 |\n\nTo load these tables to DuckDB, run:", "position": 2, "token_count": 238, "has_code": false, "section_hierarchy": [], "metadata": {"chunk_id": "guides-sql_features-asof_join-002", "document_id": "guides-sql_features-asof_join", "position": 2, "token_count": 238, "has_code": false, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join"}}
{"chunk_id": "guides-sql_features-asof_join-003", "document_id": "guides-sql_features-asof_join", "content": "To load these tables to DuckDB, run:\n\n```sql\nCREATE TABLE prices AS FROM 'https://duckdb.org/data/prices.csv';\nCREATE TABLE holdings AS FROM 'https://duckdb.org/data/holdings.csv';", "position": 3, "token_count": 62, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "guides-sql_features-asof_join-003", "document_id": "guides-sql_features-asof_join", "position": 3, "token_count": 62, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join"}}
{"chunk_id": "guides-sql_features-asof_join-004", "document_id": "guides-sql_features-asof_join", "content": "```", "position": 4, "token_count": 5, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "guides-sql_features-asof_join-004", "document_id": "guides-sql_features-asof_join", "position": 4, "token_count": 5, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join"}}
{"chunk_id": "guides-sql_features-asof_join-005", "document_id": "guides-sql_features-asof_join", "content": "## Inner AsOf Joins\n\nWe can compute the value of each holding at that point in time by finding\nthe most recent price before the holding's timestamp by using an AsOf Join:\n\n```sql\nSELECT h.ticker, h.when, price * shares AS value\nFROM holdings h\nASOF JOIN prices p\n ON h.ticker = p.ticker\n AND h.when >= p.when;\n```\n\nThis attaches the value of the holding at that time to each row:\n\n| ticker | when | value |\n| :----- | :--- | ----: |\n| APPL | 2001-01-01 00:00:30 | 2.94 |\n| APPL | 2001-01-01 00:01:30 | 48.26 |\n| GOOG | 2001-01-01 00:00:30 | 23.45 |\n| GOOG | 2001-01-01 00:01:30 | 21.16 |\n\nIt essentially executes a function defined by looking up nearby values in the `prices` table.\nNote also that missing `ticker` values do not have a match and don't appear in the output.", "position": 5, "token_count": 252, "has_code": true, "section_hierarchy": ["Inner AsOf Joins"], "metadata": {"chunk_id": "guides-sql_features-asof_join-005", "document_id": "guides-sql_features-asof_join", "position": 5, "token_count": 252, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Inner AsOf Joins"], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join#inner-asof-joins"}}
{"chunk_id": "guides-sql_features-asof_join-006", "document_id": "guides-sql_features-asof_join", "content": "## Outer AsOf Joins\n\nBecause AsOf produces at most one match from the right hand side,\nthe left side table will not grow as a result of the join,\nbut it could shrink if there are missing times on the right.\nTo handle this situation, you can use an *outer* AsOf Join:\n\n```sql\nSELECT h.ticker, h.when, price * shares AS value\nFROM holdings h\nASOF LEFT JOIN prices p\n ON h.ticker = p.ticker\n AND h.when >= p.when\nORDER BY ALL;", "position": 6, "token_count": 116, "has_code": true, "section_hierarchy": ["Outer AsOf Joins"], "metadata": {"chunk_id": "guides-sql_features-asof_join-006", "document_id": "guides-sql_features-asof_join", "position": 6, "token_count": 116, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Outer AsOf Joins"], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join#outer-asof-joins"}}
{"chunk_id": "guides-sql_features-asof_join-007", "document_id": "guides-sql_features-asof_join", "content": "```\n\nAs you might expect, this will produce `NULL` prices and values instead of dropping left side rows\nwhen there is no ticker or the time is before the prices begin.\n\n| ticker | when | value |\n| :----- | :--- | ----: |\n| APPL | 2000-12-31 23:59:30 | |\n| APPL | 2001-01-01 00:00:30 | 2.94 |\n| APPL | 2001-01-01 00:01:30 | 48.26 |\n| GOOG | 2000-12-31 23:59:30 | |\n| GOOG | 2001-01-01 00:00:30 | 23.45 |\n| GOOG | 2001-01-01 00:01:30 | 21.16 |\n| DATA | 2000-12-31 23:59:30 | |\n| DATA | 2001-01-01 00:00:30 | |\n| DATA | 2001-01-01 00:01:30 | |", "position": 7, "token_count": 220, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "guides-sql_features-asof_join-007", "document_id": "guides-sql_features-asof_join", "position": 7, "token_count": 220, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join"}}
{"chunk_id": "guides-sql_features-asof_join-008", "document_id": "guides-sql_features-asof_join", "content": "## AsOf Joins with the `USING` Keyword\n\nSo far we have been explicit about specifying the conditions for AsOf,\nbut SQL also has a simplified join condition syntax\nfor the common case where the column names are the same in both tables.\nThis syntax uses the `USING` keyword to list the fields that should be compared for equality.\nAsOf also supports this syntax, but with two restrictions:\n\n* The last field is the inequality\n* The inequality is `>=` (the most common case)\n\nOur first query can then be written as:\n\n```sql\nSELECT ticker, h.when, price * shares AS value\nFROM holdings h\nASOF JOIN prices p USING (ticker, \"when\");\n```", "position": 8, "token_count": 153, "has_code": true, "section_hierarchy": ["AsOf Joins with the `USING` Keyword"], "metadata": {"chunk_id": "guides-sql_features-asof_join-008", "document_id": "guides-sql_features-asof_join", "position": 8, "token_count": 153, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["AsOf Joins with the `USING` Keyword"], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join#asof-joins-with-the-using-keyword"}}
{"chunk_id": "guides-sql_features-asof_join-009", "document_id": "guides-sql_features-asof_join", "content": "### Clarification on Column Selection with `USING` in ASOF Joins\n\nWhen you use the `USING` keyword in a join, the columns specified in the `USING` clause are merged in the result set. This means that if you run:\n\n```sql\nSELECT *\nFROM holdings h\nASOF JOIN prices p USING (ticker, \"when\");", "position": 9, "token_count": 79, "has_code": true, "section_hierarchy": ["Clarification on Column Selection with `USING` in ASOF Joins"], "metadata": {"chunk_id": "guides-sql_features-asof_join-009", "document_id": "guides-sql_features-asof_join", "position": 9, "token_count": 79, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Clarification on Column Selection with `USING` in ASOF Joins"], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join#clarification-on-column-selection-with-using-in-asof-joins"}}
{"chunk_id": "guides-sql_features-asof_join-010", "document_id": "guides-sql_features-asof_join", "content": "```\n\nYou will get back only the columns `h.ticker, h.when, h.shares, p.price`. The columns `ticker` and `when` will appear only once, with `ticker`\nand `when` coming from the left table (holdings).\n\nThis behavior is fine for the `ticker` column because the value is the same in both tables. However, for the `when` column, the values might\ndiffer between the two tables due to the `>=` condition used in the AsOf join. The AsOf join is designed to match each row in the left\ntable (`holdings`) with the nearest preceding row in the right table (`prices`) based on the `when` column.\n\nIf you want to retrieve the `when` column from both tables to see both timestamps, you need to list the columns explicitly rather than\nrelying on `*`, like so:\n\n```sql\nSELECT h.ticker, h.when AS holdings_when, p.when AS prices_when, h.shares, p.price\nFROM holdings h\nASOF JOIN prices p USING (ticker, \"when\");", "position": 10, "token_count": 247, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "guides-sql_features-asof_join-010", "document_id": "guides-sql_features-asof_join", "position": 10, "token_count": 247, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join"}}
{"chunk_id": "guides-sql_features-asof_join-011", "document_id": "guides-sql_features-asof_join", "content": "```\n\nThis ensures that you get the complete information from both tables, avoiding any potential confusion caused by the default behavior of\nthe `USING` keyword.", "position": 11, "token_count": 34, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "guides-sql_features-asof_join-011", "document_id": "guides-sql_features-asof_join", "position": 11, "token_count": 34, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join"}}
{"chunk_id": "guides-sql_features-asof_join-012", "document_id": "guides-sql_features-asof_join", "content": "## See Also\n\nFor implementation details, see the [blog post “DuckDB's AsOf joins: Fuzzy Temporal Lookups”]({% post_url 2023-09-15-asof-joins-fuzzy-temporal-lookups %}).", "position": 12, "token_count": 59, "has_code": false, "section_hierarchy": ["See Also"], "metadata": {"chunk_id": "guides-sql_features-asof_join-012", "document_id": "guides-sql_features-asof_join", "position": 12, "token_count": 59, "has_code": false, "overlap_with_previous": true, "section_hierarchy": ["See Also"], "file_path": "guides/sql_features/asof_join.md", "url": "/guides/sql_features/asof_join", "title": "AsOf Join", "category": null, "tags": [], "section_url": "/guides/sql_features/asof_join#see-also"}}
