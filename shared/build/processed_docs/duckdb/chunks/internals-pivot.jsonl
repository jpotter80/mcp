{"chunk_id": "internals-pivot-000", "document_id": "internals-pivot", "content": "## `PIVOT`\n\n[Pivoting]({% link docs/stable/sql/statements/pivot.md %}) is implemented as a combination of SQL query re-writing and a dedicated `PhysicalPivot` operator for higher performance.\nEach `PIVOT` is implemented as set of aggregations into lists and then the dedicated `PhysicalPivot` operator converts those lists into column names and values.\nAdditional pre-processing steps are required if the columns to be created when pivoting are detected dynamically (which occurs when the `IN` clause is not in use).\n\nDuckDB, like most SQL engines, requires that all column names and types be known at the start of a query.\nIn order to automatically detect the columns that should be created as a result of a `PIVOT` statement, it must be translated into multiple queries.\n[`ENUM` types]({% link docs/stable/sql/data_types/enum.md %}) are used to find the distinct values that should become columns.\nEach `ENUM` is then injected into one of the `PIVOT` statement's `IN` clauses.", "position": 0, "token_count": 246, "has_code": false, "section_hierarchy": ["`PIVOT`"], "metadata": {"chunk_id": "internals-pivot-000", "document_id": "internals-pivot", "position": 0, "token_count": 246, "has_code": false, "overlap_with_previous": false, "section_hierarchy": ["`PIVOT`"], "file_path": "internals/pivot.md", "url": "/internals/pivot", "title": "Pivot Internals", "category": null, "tags": [], "section_url": "/internals/pivot#pivot"}}
{"chunk_id": "internals-pivot-001", "document_id": "internals-pivot", "content": "After the `IN` clauses have been populated with `ENUM`s, the query is re-written again into a set of aggregations into lists.\n\nFor example:\n\n```sql\nPIVOT cities\nON year\nUSING sum(population);", "position": 1, "token_count": 52, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "internals-pivot-001", "document_id": "internals-pivot", "position": 1, "token_count": 52, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "internals/pivot.md", "url": "/internals/pivot", "title": "Pivot Internals", "category": null, "tags": [], "section_url": "/internals/pivot"}}
{"chunk_id": "internals-pivot-002", "document_id": "internals-pivot", "content": "```\n\nis initially translated into:\n\n```sql\nCREATE TEMPORARY TYPE __pivot_enum_0_0 AS ENUM (\n SELECT DISTINCT\n year::VARCHAR\n FROM cities\n ORDER BY\n year\n );\nPIVOT cities\nON year IN __pivot_enum_0_0\nUSING sum(population);\n```\n\nand finally translated into:\n\n```sql\nSELECT country, name, list(year), list(population_sum)\nFROM (\n SELECT country, name, year, sum(population) AS population_sum\n FROM cities\n GROUP BY ALL\n)\nGROUP BY ALL;", "position": 2, "token_count": 125, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "internals-pivot-002", "document_id": "internals-pivot", "position": 2, "token_count": 125, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "internals/pivot.md", "url": "/internals/pivot", "title": "Pivot Internals", "category": null, "tags": [], "section_url": "/internals/pivot"}}
{"chunk_id": "internals-pivot-003", "document_id": "internals-pivot", "content": "```\n\nThis produces the result:\n\n| country | name | list(\"year\") | list(population_sum) |\n|---------|---------------|--------------------|----------------------|\n| NL | Amsterdam | [2000, 2010, 2020] | [1005, 1065, 1158] |\n| US | Seattle | [2000, 2010, 2020] | [564, 608, 738] |\n| US | New York City | [2000, 2010, 2020] | [8015, 8175, 8772] |\n\nThe `PhysicalPivot` operator converts those lists into column names and values to return this result:", "position": 3, "token_count": 195, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "internals-pivot-003", "document_id": "internals-pivot", "position": 3, "token_count": 195, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "internals/pivot.md", "url": "/internals/pivot", "title": "Pivot Internals", "category": null, "tags": [], "section_url": "/internals/pivot"}}
{"chunk_id": "internals-pivot-004", "document_id": "internals-pivot", "content": "The `PhysicalPivot` operator converts those lists into column names and values to return this result:\n\n| country | name | 2000 | 2010 | 2020 |\n|---------|---------------|-----:|-----:|-----:|\n| NL | Amsterdam | 1005 | 1065 | 1158 |\n| US | Seattle | 564 | 608 | 738 |\n| US | New York City | 8015 | 8175 | 8772 |", "position": 4, "token_count": 126, "has_code": false, "section_hierarchy": [], "metadata": {"chunk_id": "internals-pivot-004", "document_id": "internals-pivot", "position": 4, "token_count": 126, "has_code": false, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "internals/pivot.md", "url": "/internals/pivot", "title": "Pivot Internals", "category": null, "tags": [], "section_url": "/internals/pivot"}}
{"chunk_id": "internals-pivot-005", "document_id": "internals-pivot", "content": "## `UNPIVOT`", "position": 5, "token_count": 9, "has_code": false, "section_hierarchy": ["`UNPIVOT`"], "metadata": {"chunk_id": "internals-pivot-005", "document_id": "internals-pivot", "position": 5, "token_count": 9, "has_code": false, "overlap_with_previous": true, "section_hierarchy": ["`UNPIVOT`"], "file_path": "internals/pivot.md", "url": "/internals/pivot", "title": "Pivot Internals", "category": null, "tags": [], "section_url": "/internals/pivot#unpivot"}}
{"chunk_id": "internals-pivot-006", "document_id": "internals-pivot", "content": "### Internals\n\nUnpivoting is implemented entirely as rewrites into SQL queries.\nEach `UNPIVOT` is implemented as set of `unnest` functions, operating on a list of the column names and a list of the column values.\nIf dynamically unpivoting, the `COLUMNS` expression is evaluated first to calculate the column list.\n\nFor example:\n\n```sql\nUNPIVOT monthly_sales\nON jan, feb, mar, apr, may, jun\nINTO\n NAME month\n VALUE sales;\n```\n\nis translated into:\n\n```sql\nSELECT\n empid,\n dept,\n unnest(['jan', 'feb', 'mar', 'apr', 'may', 'jun']) AS month,\n unnest([\"jan\", \"feb\", \"mar\", \"apr\", \"may\", \"jun\"]) AS sales\nFROM monthly_sales;", "position": 6, "token_count": 197, "has_code": true, "section_hierarchy": ["Internals"], "metadata": {"chunk_id": "internals-pivot-006", "document_id": "internals-pivot", "position": 6, "token_count": 197, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Internals"], "file_path": "internals/pivot.md", "url": "/internals/pivot", "title": "Pivot Internals", "category": null, "tags": [], "section_url": "/internals/pivot#internals"}}
{"chunk_id": "internals-pivot-007", "document_id": "internals-pivot", "content": "```\n\nNote the single quotes to build a list of text strings to populate `month`, and the double quotes to pull the column values for use in `sales`.\nThis produces the same result as the initial example:", "position": 7, "token_count": 49, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "internals-pivot-007", "document_id": "internals-pivot", "position": 7, "token_count": 49, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "internals/pivot.md", "url": "/internals/pivot", "title": "Pivot Internals", "category": null, "tags": [], "section_url": "/internals/pivot"}}
{"chunk_id": "internals-pivot-008", "document_id": "internals-pivot", "content": "| empid | dept | month | sales |\n|------:|-------------|-------|------:|\n| 1 | electronics | jan | 1 |\n| 1 | electronics | feb | 2 |\n| 1 | electronics | mar | 3 |\n| 1 | electronics | apr | 4 |\n| 1 | electronics | may | 5 |\n| 1 | electronics | jun | 6 |\n| 2 | clothes | jan | 10 |\n| 2 | clothes | feb | 20 |\n| 2 | clothes | mar | 30 |\n| 2 | clothes | apr | 40 |\n| 2 | clothes | may | 50 |\n| 2 | clothes | jun | 60 |\n| 3 | cars | jan | 100 |\n| 3 | cars | feb | 200 |\n| 3 | cars | mar | 300 |\n| 3 | cars | apr | 400 |\n| 3 | cars | may | 500 |\n| 3 | cars | jun | 600 |", "position": 8, "token_count": 213, "has_code": false, "section_hierarchy": [], "metadata": {"chunk_id": "internals-pivot-008", "document_id": "internals-pivot", "position": 8, "token_count": 213, "has_code": false, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "internals/pivot.md", "url": "/internals/pivot", "title": "Pivot Internals", "category": null, "tags": [], "section_url": "/internals/pivot"}}
