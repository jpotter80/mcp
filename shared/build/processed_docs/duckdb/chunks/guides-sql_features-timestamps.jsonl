{"chunk_id": "guides-sql_features-timestamps-000", "document_id": "guides-sql_features-timestamps", "content": "## Timestamp with Time Zone Promotion Casts\n\nWorking with time zones in SQL can be quite confusing at times.\nFor example, when filtering to a date range, one might try the following query:\n\n```sql\nSET timezone = 'America/Los_Angeles';\n\nCREATE TABLE times AS\n FROM range('2025-08-30'::TIMESTAMPTZ, '2025-08-31'::TIMESTAMPTZ, INTERVAL 1 HOUR) tbl(t);\n\nFROM times WHERE t <= '2025-08-30';\n```\n\n```text\n┌──────────────────────────┐\n│ t │\n│ timestamp with time zone │\n├──────────────────────────┤\n│ 2025-08-30 00:00:00-07 │\n└──────────────────────────┘\n```\n\nBut if you change to another time zone, the results of the query change:\n\n```sql\nSET timezone = 'HST';\nFROM times WHERE t <= '2025-08-30';", "position": 0, "token_count": 203, "has_code": true, "section_hierarchy": ["Timestamp with Time Zone Promotion Casts"], "metadata": {"chunk_id": "guides-sql_features-timestamps-000", "document_id": "guides-sql_features-timestamps", "position": 0, "token_count": 203, "has_code": true, "overlap_with_previous": false, "section_hierarchy": ["Timestamp with Time Zone Promotion Casts"], "file_path": "guides/sql_features/timestamps.md", "url": "/guides/sql_features/timestamps", "title": "Timestamp Issues", "category": null, "tags": [], "section_url": "/guides/sql_features/timestamps#timestamp-with-time-zone-promotion-casts"}}
{"chunk_id": "guides-sql_features-timestamps-001", "document_id": "guides-sql_features-timestamps", "content": "```\n\nBut if you change to another time zone, the results of the query change:\n\n```sql\nSET timezone = 'HST';\nFROM times WHERE t <= '2025-08-30';\n```\n\n```text\n┌──────────────────────────┐\n│ t │\n│ timestamp with time zone │\n├──────────────────────────┤\n│ 2025-08-29 21:00:00-10 │\n│ 2025-08-29 22:00:00-10 │\n│ 2025-08-29 23:00:00-10 │\n│ 2025-08-30 00:00:00-10 │\n└──────────────────────────┘\n```\n\nOr worse:\n\n```sql\nSET timezone = 'America/New_York';\nFROM times WHERE t <= '2025-08-30';\n```\n\n```text\n┌──────────────────────────┐\n│ t │\n│ timestamp with time zone │\n├──────────────────────────┤\n│ 0 rows │\n└──────────────────────────┘", "position": 1, "token_count": 192, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "guides-sql_features-timestamps-001", "document_id": "guides-sql_features-timestamps", "position": 1, "token_count": 192, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/sql_features/timestamps.md", "url": "/guides/sql_features/timestamps", "title": "Timestamp Issues", "category": null, "tags": [], "section_url": "/guides/sql_features/timestamps"}}
{"chunk_id": "guides-sql_features-timestamps-002", "document_id": "guides-sql_features-timestamps", "content": "```\n\n```text\n┌──────────────────────────┐\n│ t │\n│ timestamp with time zone │\n├──────────────────────────┤\n│ 0 rows │\n└──────────────────────────┘\n```\n\nThese confusing results are due to the SQL casting rules from `DATE` to `TIMESTAMP WITH TIME ZONE`.\nThis cast is required to promote the date to midnight _in the current time zone_.\n\nIn general, unless you need to use the current time zone for display (or\n[other temporal binning]({% post_url 2022-01-06-time-zones %}) operations)\nyou should use plain `TIMESTAMP`s for temporal data.\nThis will avoid confusing issues such as this, and the arithmetic operations are generally faster.", "position": 2, "token_count": 147, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "guides-sql_features-timestamps-002", "document_id": "guides-sql_features-timestamps", "position": 2, "token_count": 147, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/sql_features/timestamps.md", "url": "/guides/sql_features/timestamps", "title": "Timestamp Issues", "category": null, "tags": [], "section_url": "/guides/sql_features/timestamps"}}
{"chunk_id": "guides-sql_features-timestamps-003", "document_id": "guides-sql_features-timestamps", "content": "## Time Zone Performance\n\nDuckDB uses the _International Components for Unicode_ time library for\n[time zone support]({% post_url 2022-01-06-time-zones %}).\nThis library has a number of advantages, including support for daylight savings time past 2037.\n(Note: Pandas gives incorrect results past that year).\n\nThe downside of using ICU is that it is not highly performant.\nOne workaround for this is to create a calendar table for the timestamps being modeled.\nFor example, if the application is modeling electrical supply and demand out to 2100 at hourly resolution,\none can create the calendar table like so:\n\n```sql\nSET timezone = 'Europe/Netherlands';", "position": 3, "token_count": 155, "has_code": true, "section_hierarchy": ["Time Zone Performance"], "metadata": {"chunk_id": "guides-sql_features-timestamps-003", "document_id": "guides-sql_features-timestamps", "position": 3, "token_count": 155, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Time Zone Performance"], "file_path": "guides/sql_features/timestamps.md", "url": "/guides/sql_features/timestamps", "title": "Timestamp Issues", "category": null, "tags": [], "section_url": "/guides/sql_features/timestamps#time-zone-performance"}}
{"chunk_id": "guides-sql_features-timestamps-004", "document_id": "guides-sql_features-timestamps", "content": "```sql\nSET timezone = 'Europe/Netherlands';\n\nCREATE OR REPLACE TABLE hourly AS\n SELECT\n ts,\n year::SMALLINT AS year,\n month::TINYINT AS month,\n day::TINYINT AS day,\n hour::TINYINT AS hour,\n FROM (\n SELECT ts, unnest(date_part(['year', 'month', 'day', 'hour',], ts))\n FROM generate_series(\n '2020-01-01'::DATE::TIMESTAMPTZ,\n '2100-01-01'::DATE::TIMESTAMPTZ,\n INTERVAL 1 HOUR) tbl(ts)\n ) parts;", "position": 4, "token_count": 144, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "guides-sql_features-timestamps-004", "document_id": "guides-sql_features-timestamps", "position": 4, "token_count": 144, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/sql_features/timestamps.md", "url": "/guides/sql_features/timestamps", "title": "Timestamp Issues", "category": null, "tags": [], "section_url": "/guides/sql_features/timestamps"}}
{"chunk_id": "guides-sql_features-timestamps-005", "document_id": "guides-sql_features-timestamps", "content": "```\n\nYou can then join this ~700K row table against any timestamp column\nto quickly obtain the temporal bin values for the time zone in question.\nThe inner casts are not required, but result in a smaller table\nbecause `date_part` returns 64 bit integers for all parts.\n\nNotice that we can extract _all_ of the parts with a single call to `date_part`.\nThis part list version of the function is faster than extracting the parts one by one\nbecause the underlying binning computation computes all parts,\nso picking out the ones in the list is avoids duplicate calls to the slow ICU function.\n\nAlso notice that we are leveraging the `DATE` cast rules from the previous section\nto bound the calendar to the model domain.", "position": 5, "token_count": 157, "has_code": true, "section_hierarchy": [], "metadata": {"chunk_id": "guides-sql_features-timestamps-005", "document_id": "guides-sql_features-timestamps", "position": 5, "token_count": 157, "has_code": true, "overlap_with_previous": true, "section_hierarchy": [], "file_path": "guides/sql_features/timestamps.md", "url": "/guides/sql_features/timestamps", "title": "Timestamp Issues", "category": null, "tags": [], "section_url": "/guides/sql_features/timestamps"}}
{"chunk_id": "guides-sql_features-timestamps-006", "document_id": "guides-sql_features-timestamps", "content": "## Half Open Intervals\n\nAnother subtle problem in using SQL for temporal analytics is the `BETWEEN` operator.\nTemporal analytics almost always uses\n[half-open binning intervals](https://www.cs.arizona.edu/~rts/tdbbook.pdf)\nto avoid overlaps at the ends.\nUnfortunately, the `BETWEEN` operator is a closed-closed interval:\n\n```sql\nx BETWEEN begin AND end\n-- expands to\nbegin <= x AND x <= end\n-- not\nbegin <= x AND x < end\n\n```\n\nTo avoid this problem, make sure you are explicit about comparison boundaries instead of using `BETWEEN`.", "position": 6, "token_count": 138, "has_code": true, "section_hierarchy": ["Half Open Intervals"], "metadata": {"chunk_id": "guides-sql_features-timestamps-006", "document_id": "guides-sql_features-timestamps", "position": 6, "token_count": 138, "has_code": true, "overlap_with_previous": true, "section_hierarchy": ["Half Open Intervals"], "file_path": "guides/sql_features/timestamps.md", "url": "/guides/sql_features/timestamps", "title": "Timestamp Issues", "category": null, "tags": [], "section_url": "/guides/sql_features/timestamps#half-open-intervals"}}
